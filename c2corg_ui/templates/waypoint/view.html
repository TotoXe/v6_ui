<%!
from c2corg_ui.templates.utils import get_lang_lists
%>\
<%inherit file="../base.html"/>
<%namespace file="../helpers/common.html" import="show_title"/>
<%namespace file="../helpers/view.html" import="show_attr, show_short_attr, show_missing_langs_links,
    show_other_langs_links, show_archive_data, show_route_title, show_associated_waypoints,
    show_associated_routes, show_areas, show_maps"/>
<%
waypoint_id = waypoint['document_id']
other_langs, missing_langs = get_lang_lists(waypoint, lang)

## FIXME: transform() makes server crash in apache mode. Reprojection is then temporarly deactivated.
##geometry4326 = transform(geometry, 'epsg:3857', 'epsg:4326')
geometry4326 = geometry
%>\
<%block name="pagelang">lang="${lang}"</%block>\
<%block name="pagetitle"><title>${show_route_title(locale, True)}</title></%block>\
<%block name="metarobots">\

  % if version:
<meta name="robots" content="noindex,follow">\
  % else:
<meta name="robots" content="index,follow">\
  % endif
</%block>\

<%block name="moduleConstantsValues">
module.value('mapFeatureCollection', {
  "type": "FeatureCollection",
  "properties": {},
  "features": [{
    "type": "Feature",
    "geometry": {"type": "Point", "coordinates": [${geometry.x}, ${geometry.y}]},
    "properties": {
      "title": "${locale['title']}",
      % if waypoint['waypoint_type'] != 'climbing_outdoor':
      "elevation": ${waypoint['elevation']},
      % endif
      "module": "waypoints",
      "type": "${waypoint['waypoint_type']}"
    }
  }]
});
</%block>\

<header class="view-details-title">
  <h1>${locale['title']} <label class="badge" translate>waypoint</label></h1>
</header>

<app-map class="view-details-map"></app-map>

<section class="view-details-section" app-view-details>
  <uib-tabset>
    <uib-tab heading="Description" ng-click="detailsCtrl.openTab('.view-details-description')"></uib-tab>
    <uib-tab heading="Details" ng-click="detailsCtrl.openTab('.view-details-list')"></uib-tab>
    <uib-tab heading="Associations" ng-click="detailsCtrl.openTab('.view-details-associations')"></uib-tab>
  </uib-tabset>

  <div class="thumbnail view-details-list col-xs-12 tab">
    ## LOCATION
    <div class="name-icon-value col-sm-6" ng-click="detailsCtrl.openTab($event)">
      <h4><span translate>Location</span><span class="glyphicon glyphicon-menu-right"></span></h4>
      <div class="name-icon">
        <span class="glyphicon glyphicon-map-marker"></span>
        <p translate>Location</p>
      </div>
      <span class="detail-text accordion">
        % if not version:
          ${show_areas(waypoint)}
        % endif
        <p>${round(geometry4326.x)} °E / ${round(geometry4326.y)} °N</p>
      </span>
    </div>

    ## GENERAL
    <div class="name-icon-value col-sm-6" ng-click="detailsCtrl.openTab($event)">
      <h4><span translate>General</span><span class="glyphicon glyphicon-menu-right"></span></h4>
      <div class="name-icon">
        <span class="glyphicon glyphicon-stats"></span>
        <p translate>General</p>
      </div>
      <span class="detail-text accordion">
        <p><span translate>waypoint_type</span>: <b>${waypoint['waypoint_type']}</b></p>
        <p><span translate>elevation</span>: <b>${waypoint['elevation']} m</b></p>
      </span>
    </div>

    ## SUMMARY
    % if locale['summary']:
    <div class="name-icon-value col-sm-6" ng-click="detailsCtrl.openTab($event)">
      <h4><span translate>summary</span><span class="glyphicon glyphicon-menu-right"></span></h4>
        <div class="name-icon">
          <span class="glyphicon glyphicon-list-alt"></span>
          <p translate>summary</p>
        </div>
      <span class="detail-text accordion">
       ${locale['summary']}
      </span>
    </div>
    % endif

    ## MAPSINFO
    % if waypoint['maps_info']:
    <div class="name-icon-value col-sm-6" ng-click="detailsCtrl.openTab($event)">
      <h4><span translate>maps_info</span><span class="glyphicon glyphicon-menu-right"></span></h4>
      <div class="name-icon">
        <span class="glyphicon glyphicon-info-sign"></span>
        <p translate>maps_info</p>
      </div>
      <span class="detail-text accordion">
        <p><span translate>maps_info</span>:<b>${waypoint['maps_info']}</b></p>
      </span>
    </div>
    % endif
  </div>

  ## DESCRIPTION
  <div class="view-details-description col-xs-12 tab">
    <span class="lead">
      % if locale['description']:
        <h3 translate class="text-center heading">description</h3>
        ${show_attr(locale, 'description')}
      % else :
        <h3 class="text-center" translate>No description available</h3>
      % endif
    </span>
  </div>

  % if not version:
    <div class="view-details-associations col-xs-12 tab">
      <span class="lead">
        <h3 class="text-center heading" translate>Associations</h3>
        <div ng-show="userCtrl.auth.isAuthenticated()"><span translate>Add association</span>:
          <app-add-association parent-id="${waypoint_id}" added-documents="added"></app-add-association>
        </div>
        <div><span translate>Waypoints</span>: ${show_associated_waypoints(waypoint)}
          <ul>
            <li ng-repeat="doc in added | filter:{'documentType': 'waypoints'}">
              <app-association-card></app-association-card>
            </li>
          </ul>
        </div>
        <div><span translate>Routes</span>: ${show_associated_routes(waypoint)}
          <ul>
            <li ng-repeat="doc in added | filter:{'documentType': 'routes'}">
              <app-association-card doc="doc"></app-association-card>
            </li>
          </ul>
        </div>
        <div><span translate>Maps</span>: ${show_maps(waypoint)}</div>
      </span>
    </div>
  % endif

  <div class="col-lg-7 col-md-7 col-xs-12 detail-buttons">
    % if version:
      ${show_archive_data('waypoints', waypoint, locale, version)}
    % else:
      ${show_other_langs_links('waypoints', waypoint, other_langs)}
      ${show_missing_langs_links('waypoints', waypoint, missing_langs)}
    % endif
  </div>
  <div class="text-center col-xs-12">
    <button class="btn btn-default scroll-top-btn" onclick="window.scrollTo(0, 0);"translate>To page head <span class="glyphicon glyphicon-menu-up"></span></button>
  </div>
</section>

<div class="float-buttons">
  <div class="float-button float-edit" tooltip-placement="top" uib-tooltip="{{'Edit' | translate}}">
    <app-edit-button ng-click="ebCtrl.redirect()" app-edit-button-url="${request.route_url('waypoints_edit', id=waypoint_id, lang=lang)}"></app-edit-button>
    <span class="glyphicon glyphicon-edit"></span>
    <p class="float-button-text" translate>Edit</p>
  </div>
  <div class="float-button float-favorite" tooltip-placement="top" uib-tooltip="{{'Add to favorites' | translate}}">
    <span class="glyphicon glyphicon-heart"></span>
    <p class="float-button-text" translate>Favorites</p>
  </div>
  <div class="float-button float-add" tooltip-placement="top" uib-tooltip="{{'Add' | translate}}">
    <span class="glyphicon glyphicon-plus"></span>
    <p class="float-button-text" translate>Add</p>
  </div>
  <div class="float-button float-comments" tooltip-placement="top" uib-tooltip="{{'Comments' | translate}}">
    <span class="glyphicon glyphicon-comment"></span>
    <p class="float-button-text" translate>Comments</p>
  </div>
  <div class="btn-group float-more float-button " uib-dropdown>
    <span class="glyphicon glyphicon-th-list dropdown-toggle" uib-dropdown-toggle></span>
    <p class="float-button-text" translate>More</p>
    <ul class="dropdown-menu"  role="menu" aria-labelledby="dLabel">
      % if version:
      <li>${show_archive_data('waypoints', waypoint, locale, version)}</li>
      % endif
      <li><a href="${request.route_url('waypoints_history', id=waypoint_id, lang=lang)}" translate>History</a></li>
      % if other_langs:
      <li ng-click="detailsCtrl.openModal('#other-langs')"><a translate>View in other lang</a></li>
      % endif
      % if missing_langs:
      <li ng-click="detailsCtrl.openModal('#missing-langs')"><a translate>Translate into an other lang</a></li>
      % endif
      <li role="separator" class="divider"></li>
      <li><a href="#">Print</a></li>
      <li><a href="#">Save</a></li>
    </ul>
  </div>
</div>
